<div *ngIf="user && !user.guest else showLogin">

  <button (click)="taskService.showCategoryPopup()" [disabled]="taskService.categoryPopup">New task category</button>
  <br>
  <!-- New Category -->
  <div class="popupContainer" *ngIf="taskService.categoryPopup">
    <div class="popup">
      <h4>New task category</h4>
      <form (ngSubmit)="taskService.newCategory(name.value)">
        <input type="text" placeholder="Name" autocomplete="off" #name name="n">
        <br>
        <button type="submit" [disabled]="taskService.actionInProgress">
          Submit
          <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress"></i>
        </button>
        <button type="reset" [disabled]="taskService.actionInProgress" (click)="taskService.closePopups()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Categories -->
  <div class="headerSpacer"></div>
  <div class="sectionHeader">
    Not Started
  </div>
  <div class="sectionHeader">
    In Progress
  </div>
  <div class="sectionHeader">
    Completed
  </div>
  <div class="category" *ngFor="let category of taskCategories">
    <div class="nameOfCategory">
      <h3>{{ category.name }}</h3>
    </div>

    <!-- Tasks Not started -->
    <section class="tasks">
      <div class="task" *ngFor="let task of taskService.filterTasksByStatus(category.tasks, 'not started')" [class.disabledTask]="taskService.editTaskPopup && activeTask != task">
        <div class="taskPrio {{ task.priority }}" title="Task priority">
          {{ task.priority }}
        </div>

        <div class="main">
          <div class="taskName" title="{{ task.description }}">
            {{ task.name }}
          </div>
          <div class="taskPoints" title="Points">
            {{ task.points }}
          </div>
        </div>
        <!-- Buttons -->
        <div class="taskButtons">
          <i class="fa fa-trash link" (click)="taskService.showDeleteConfirmation = true; name_key = category.name_key; deleteId = task.id"></i>
          <i class="fa fa-edit link" (click)="taskService.showEditTaskPopup(); name_key = category.name_key; activeTask = task"></i>
          <i class="fa fa-forward link" (click)="taskService.changeTaskStatus(category.name_key, task.id, 'in progress')"></i>
        </div>
      </div>

      <button class="addTask" (click)="taskService.showNewTaskPopup(); activeCategory = category; testXY(category.name)" [id]="category.name" [disabled]="taskService.newTaskPopup && activeCategory == category">
        +
      </button>
    </section>

    <!-- Tasks In Progress -->
    <section class="tasks">
      <div class="task" *ngFor="let task of taskService.filterTasksByStatus(category.tasks, 'in progress')" [class.disabledTask]="taskService.editTaskPopup && activeTask != task">
        <div class="taskPrio {{ task.priority }}" title="{{ task.editedDate }}">
         <!-- title="Task priority"> -->
          {{ task.priority }}
        </div>

        <div class="main">
          <div class="taskName" title="{{ task.description }}">
            {{ task.name }}
          </div>
          <div class="taskPoints" title="Points">
            {{ task.points }}
          </div>
        </div>

        <div class="taskButtons">
          <i class="fa fa-backward link" (click)="taskService.changeTaskStatus(category.name_key, task.id, 'not started')"></i>
          <i class="fa fa-trash link" (click)="taskService.showDeleteConfirmation = true; name_key = category.name_key; deleteId = task.id"></i>
          <i class="fa fa-edit link" (click)="taskService.showEditTaskPopup(); name_key = category.name_key; activeTask = task"></i>
          <i class="fa fa-forward link" (click)="taskService.changeTaskStatus(category.name_key, task.id, 'completed')"></i>
        </div>
      </div>
    </section>

    <!-- Completed Tasks -->
    <section class="tasks">
      <div class="task" *ngFor="let task of taskService.filterTasksByStatus(category.tasks, 'completed')" [class.disabledTask]="taskService.editTaskPopup && activeTask != task">
        <div class="taskPrio {{ task.priority }}" title="Task priority">
          {{ task.priority }}
        </div>

        <div class="main">
          <div class="taskName" title="{{ task.description }}">
            {{ task.name }}
          </div>
          <div class="taskPoints" title="Points">
            {{ task.points }}
          </div>
        </div>

        <div class="taskButtons">
          <i class="fa fa-backward link" (click)="taskService.changeTaskStatus(category.name_key, task.id, 'in progress')"></i>
          <i class="fa fa-trash link" (click)="taskService.showDeleteConfirmation = true; name_key = category.name_key; deleteId = task.id"></i>
          <i class="fa fa-edit link" (click)="taskService.showEditTaskPopup(); name_key = category.name_key; activeTask = task"></i>
        </div>
      </div>
    </section>
  </div>


  <!-- Edit Task Popup -->
  <div class="popup_fixed" *ngIf="taskService.editTaskPopup">
    <!-- <div class="popup"> -->
    <h4>Edit task</h4>
    <form (ngSubmit)="taskService.editTask(name_key, activeTask.id, name.value, description.value, points.value, priority.value)">
      <input type="text" placeholder="Name" autofocus autocomplete="off" [ngModel]="activeTask.name" #name name="n">
      <br>
      <textarea placeholder="Description" autocomplete="off" [ngModel]="activeTask.description" #description name="d"></textarea>
      <br>
      <select [ngModel]="activeTask.points" #points name="po">
        <option value="1">Points: 1</option>
        <option value="2">Points: 2</option>
        <option value="3">Points: 3</option>
        <option value="5">Points: 5</option>
        <option value="8">Points: 8</option>
        <option value="13">Points: 13</option>
        <option value="21">Points: 21</option>
      </select>
      <br>
      <select [ngModel]="activeTask.priority" #priority name="pr">
        <option value="low">Priority: Low</option>
        <option value="medium">Priority: Medium</option>
        <option value="high">Priority: High</option>
        <option value="critical">Priority: Critical</option>
      </select>
      <br>

      <button type="submit" [disabled]="taskService.actionInProgress">
        Edit
        <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress"></i>
      </button>
      <button type="reset" (click)="taskService.closePopups()" [disabled]="taskService.actionInProgress">Cancel</button>
    </form>
    <!-- </div> -->
  </div>

  <!-- Delete Confirmation Popup -->
  <div class="popup_fixed" *ngIf="taskService.showDeleteConfirmation">
    <!-- <div class="popup mediumPrompt"> -->
    This action cannot be undone! Are you sure you want to delete the task?
    <br>
    <button (click)="taskService.deleteTask(name_key, deleteId)" [disabled]="taskService.actionInProgress">
      Yes
      <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress"></i>
    </button>
    <button (click)="taskService.showDeleteConfirmation = false" [disabled]="taskService.actionInProgress">No</button>
    <!-- </div> -->
  </div>

  <!-- New Task Popup -->
  <div class="popup_fixed mediumPrompt" *ngIf="taskService.newTaskPopup">
    <!-- <div class="popup"> -->
    <h4>New task in {{ activeCategory.name }}</h4>
    <form (ngSubmit)="taskService.newTask(activeCategory.name_key, name.value, description.value, points.value, priority.value)">
      <input type="text" placeholder="Name" autofocus autocomplete="off" #name name="n">
      <br>
      <textarea placeholder="Description" autocomplete="off" #description name="d"></textarea>
      <br>
      <select #points name="po">
        <option value="1">Points: 1</option>
        <option value="2">Points: 2</option>
        <option value="3">Points: 3</option>
        <option value="5">Points: 5</option>
        <option value="8">Points: 8</option>
        <option value="13">Points: 13</option>
        <option value="21">Points: 21</option>
      </select>
      <br>
      <select #priority name="pr">
        <option value="low">Priority: Low</option>
        <option value="medium">Priority: Medium</option>
        <option value="high">Priority: High</option>
        <option value="critical">Priority: Critical</option>
      </select>
      <br>

      <button type="submit" [disabled]="actionInProgress">
        Submit
        <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress"></i>
      </button>
      <button type="reset" (click)="taskService.closePopups()" [disabled]="taskService.actionInProgress">Cancel</button>
    </form>
    <!-- </div> -->
  </div>


</div>

<ng-template #showLogin>
  <!-- <app-404></app-404> -->
  You have to be logged in as a registered user to view this page
</ng-template>