<title>Tasks - Comm</title>
<div *ngIf="user && !user.guest else showLogin" 
[class.blurredContent]="taskService.newCategoryPopup || taskService.editCategoryPopup || taskService.deleteCategoryPopup || taskService.newTaskPopup || taskService.editTaskPopup">
  <!-- <fieldset [disabled]="taskService.actionInProgress"> -->
    <button #el (click)="taskService.showNewCategoryPopup(el); globalService.setFocus('newCategoryName')" [disabled]="taskService.newCategoryPopup">New category</button>
    <br>
    <br>

    <!-- Categories -->
    <div class="category" *ngFor="let category of taskCategories" [id]="category.name" [class.collapsedCategory]="category.collapsed"
      [class.hidden]="taskService.pendingDeletion == category.name">
      <div class="nameOfCategory">
        <h4>
          <span (mouseover)="editCategory = category.name" *ngIf="(editCategory || editMode) != category.name">
            <input type="text" autocomplete="off" [value]="category.name">
          </span>
          <span (mouseout)="editCategory = undefined" (click)="editMode = category.name" *ngIf="(editCategory || editMode) == category.name">
            <form [id]="category.name" (ngSubmit)="taskService.editCategory(category, name.value); editCategory = undefined; editMode = undefined">
              <input type="text" autocomplete="off" [value]="category.name" #name name="n" id="newName" (blur)="editMode = undefined">
            </form>
          </span>

          <span *ngIf="!category.collapsed else showCollapsedCategory">
            <i class="fa fa-minus link" (click)="category.collapsed = true; taskService.collapseCategory(category.name, true)" title="Collapse category"
              *ngIf="!category.collapsed else showCollapsedName"></i>
            <br>
            <i class="fa fa-trash link" #el (click)="taskService.showDeleteCategoryPopup(el); activeCategory = category" title="Delete this category" *ngIf="category.tasks.length == 0"></i>
            <i class="fa fa-trash disabledIcon" title="Cannot delete this category as it contains tasks" *ngIf="category.tasks.length > 0"></i>
          </span>
          <!-- Collapsed category -->
          <ng-template #showCollapsedCategory>
            <i class="fa fa-plus link" (click)="category.collapsed = false; taskService.collapseCategory(category.name, false); globalService.scrollTo(category.name)" title="Expand category"></i>
            <br>
            <span title="#not started + #in progress + #completed">({{ taskService.activeTasksCounter(category.tasks) }})</span>
          </ng-template>
        </h4>
      </div>
      <!-- Tasks - all status blocks -->
      <ng-container *ngFor="let status of taskService.statusBlocks">
        <section class="tasks" *ngIf="!category.collapsed">
          <!-- New Placeholder Task -->
          <!-- <div class="task" *ngIf="status == 'not started'">
            <div class="taskPrio">&nbsp;</div>
            <div class="main">
              <div class="taskSubject">

            </div>
            <div class="taskPoints"></div>
            </div>
            <div class="taskButtons">&nbsp;</div>
          </div> -->

          <span class="header">
            {{ status }} ({{ taskService.getTasksInStatusBlock(category.tasks, status) }})
          </span>
          
          <div class="task" *ngFor="let task of taskService.filterByStatusAndSort(category.tasks, status)" 
          [class.disabledTask]="task.priority == 0">
          <!-- [class.activeTask]="(taskService.editTaskPopup || taskService.deleteTaskPopup) && activeTask == task" -->
            <div class="taskPrio {{ prioText[task.priority] }}" title="Task priority: {{ prioText[task.priority] }}">
              <!-- {{ prioText[task.priority] }} -->
            </div>
            <div class="main">
              <div class="taskSubject" [class.finishedTask]="task.status == 'completed'" [title]="task.status == 'not started' ? task.description : (task.status == 'in progress' ? task.description + '\n\nTask started at ' + task.startedAt.substring(0, 16) : task.description + '\n\nTask started at ' + task.startedAt.substring(0, 16) + '\nTask completed at ' + task.completedAt.substring(0, 16))">
                {{ task.subject }}
              </div>
              <div class="taskPoints" title="Points">
                {{ task.points }}
              </div>
            </div>
            <!-- Task Buttons -->
            <div class="taskButtons">
              <span style="text-align: left">
                <i class="fa fa-backward" [class.link]="task.status != 'not started' && task.priority > 0" [class.disabledIcon]="status == 'not started' || task.priority == 0"
                  (click)="task.status != 'not started'  &&task.priority > 0 ? taskService.changeTaskStatus(category, task.id, -1) : ''"
                  [title]="task.status == 'in progress' && task.priority > 0 ? 'Abort task' : (task.status == 'completed' ? 'Restart task' : '')"></i>
              </span>
              <span style="text-align: center">
                <i class="fa fa-edit link" #el (click)="taskService.showEditTaskPopup(el); globalService.setFocus('editTaskSubject'); activeCategory = category; destinationCategory = category; activeTask = task"></i>
              </span>
              <span style="text-align: right">
                <i class="fa fa-forward" [class.link]="task.status != 'completed' && task.priority > 0" [class.disabledIcon]="status == 'completed' || task.priority == 0"
                  (click)="task.status != 'completed' && task.priority > 0 ? taskService.changeTaskStatus(category, task.id, 1) : ''"
                  [title]="task.status == 'not started' && task.priority > 0 ? 'Start task' : (task.status == 'in progress' && task.priority > 0 ? 'Complete task' : '')"></i>
              </span>
            </div>
          </div>

          <button class="addTask" #el (click)="taskService.showNewTaskPopup(el); globalService.setFocus('newTaskSubject'); activeCategory = category" [disabled]="taskService.newTaskPopup && activeCategory == category || taskService.actionInProgress"
            *ngIf="status == 'not started'">
            +
          </button>
        </section>
      </ng-container>

    </div>
  <!-- </fieldset> -->
</div>

<div class="lightsoff" (click)="taskService.actionInProgress ? '' : taskService.closePopups()" 
*ngIf="taskService.newCategoryPopup || taskService.editCategoryPopup || taskService.deleteCategoryPopup || taskService.newTaskPopup || taskService.editTaskPopup"></div>

<!-- New Category Popup -->
<div class="popup" [style.top]="taskService.activeParentElement.offsetTop + 100 + 'px'" [style.left]="taskService.activeParentElement.offsetLeft + 50 + 'px'" *ngIf="taskService.newCategoryPopup">
  <!-- {{ name.focus() }} -->
  <h4>New category</h4>
  <form (ngSubmit)="taskService.newCategory(name.value)">
    <input type="text" placeholder="Name" autocomplete="off" id="newCategoryName" #name name="n">
    <br>
    <button type="submit" [disabled]="taskService.actionInProgress">
      Submit
      <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress"></i>
    </button>
    <button type="reset" [disabled]="taskService.actionInProgress" (click)="taskService.closePopups()">Cancel</button>
  </form>
</div>


<!-- Edit Category Popup ----------Not used--------- -->
<div class="popup_fixed" *ngIf="taskService.editCategoryPopup">
  <!-- {{ name.focus() }} -->
  <h4>Edit category</h4>
  <form (ngSubmit)="taskService.editCategory(activeCategory, name.value)">
    <fieldset [disabled]="taskService.actionInProgress || taskService.deleteCategoryPopup">
      <input type="text" placeholder="Name" autocomplete="off" [value]="activeCategory.name" id="editCategoryName" #name name="n">
      <br>
      <button type="submit">
        Save
        <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress && !taskService.deleteCategoryPopup"></i>
      </button>
      <button type="reset" (click)="taskService.closePopups()">Cancel</button>
      <button type="button" (click)="taskService.showDeleteCategoryPopup()" [disabled]="activeCategory.tasks.length > 0" [title]="activeCategory.tasks.length > 0 ? 'Cannot delete a category containing tasks' : ''">Delete category</button>
    </fieldset>
  </form>
</div>


<!-- Delete Category Confirmation Popup -->
<div class="popup confirmationPrompt" [style.top]="taskService.activeParentElement.offsetTop - 30 + 'px'" [style.left]="taskService.activeParentElement.offsetLeft + 75 + 'px'" *ngIf="taskService.deleteCategoryPopup">
  This action cannot be undone! Are you sure you want to delete '{{ activeCategory.name }}'?
  <br>
  <button (click)="taskService.deleteCategory(activeCategory)" [disabled]="taskService.actionInProgress">
    Yes
    <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress"></i>
  </button>
  <button (click)="taskService.deleteCategoryPopup = undefined" [disabled]="taskService.actionInProgress">No</button>
</div>


<!-- New Task Popup -->
<div class="popup" [style.top]="taskService.activeParentElement.offsetTop - 100 + 'px'" [style.left]="taskService.activeParentElement.offsetLeft + 150 + 'px'" *ngIf="taskService.newTaskPopup">
  <!-- {{ subject.focus() }} -->
  <h4>New task in {{ activeCategory.name }}</h4>
  <form (ngSubmit)="taskService.newTask(activeCategory, subject.value, description.value, points.value, priority.value)">
    <fieldset [disabled]="taskService.actionInProgress">
      <input type="text" placeholder="Subject" autocomplete="off" id="newTaskSubject" #subject name="s">
      <br>
      <textarea placeholder="Description" autocomplete="off" #description name="d"></textarea>
      <br>
      <select #points name="po">
        <option value="1">Points: 1</option>
        <option value="2">Points: 2</option>
        <option value="3">Points: 3</option>
        <option value="5">Points: 5</option>
        <option value="8">Points: 8</option>
        <option value="13">Points: 13</option>
        <option value="21">Points: 21</option>
      </select>
      <br>
      <select #priority name="pr">
        <option value="1">Priority: Low</option>
        <option value="2">Priority: Medium</option>
        <option value="3">Priority: High</option>
        <option value="4">Priority: Critical</option>
      </select>
      <br>

      <button type="submit" [disabled]="actionInProgress">
        Submit
        <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress"></i>
      </button>
      <button type="reset" (click)="taskService.closePopups()">Cancel</button>
    </fieldset>
  </form>
</div>


<!-- Edit Task Popup -->
<div class="popup" [style.top]="taskService.activeParentElement.offsetTop - 250 + 'px'" [style.left]="taskService.activeParentElement.offsetLeft + 90 + 'px'" *ngIf="taskService.editTaskPopup">
  <!-- {{ subject.focus() }} -->
  <h4>Edit task</h4>
  <form (ngSubmit)="taskService.editTask(activeCategory, destinationCategory, activeTask.id, subject.value, description.value, points.value, priority.value)">
    <fieldset [disabled]="taskService.actionInProgress || taskService.deleteTaskPopup">
      <select [(ngModel)]="destinationCategory" name="dc">
        <option *ngFor="let category of taskCategories" [ngValue]="category">{{ activeCategory == category ? '&raquo;' : '' }} {{ category.name }}</option>
      </select>
      <br>
      <input type="text" placeholder="Subject" autocomplete="off" [value]="activeTask.subject" id="editTaskSubject" #subject name="s">
      <br>
      <textarea placeholder="Description" autocomplete="off" [value]="activeTask.description" #description name="d"></textarea>
      <br>
      <select [value]="activeTask.points" #points name="po">
        <option value="1">Points: 1</option>
        <option value="2">Points: 2</option>
        <option value="3">Points: 3</option>
        <option value="5">Points: 5</option>
        <option value="8">Points: 8</option>
        <option value="13">Points: 13</option>
        <option value="21">Points: 21</option>
      </select>
      <br>
      <select [value]="activeTask.priority" #priority name="pr">
        <option value="0" *ngIf="activeTask.status != 'completed'">Disabled</option>
        <option value="1">Priority: Low</option>
        <option value="2">Priority: Medium</option>
        <option value="3">Priority: High</option>
        <option value="4">Priority: Critical</option>
      </select>
      <br>

      <button type="submit">
        Save
        <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress && !taskService.deleteTaskPopup"></i>
      </button>
      <button type="reset" (click)="taskService.closePopups()">Cancel</button>
      <button type="button" (click)="taskService.showDeleteTaskPopup()">Delete</button>
    </fieldset>
  </form>
</div>


<!-- Delete Task Confirmation Popup -->
<div class="popup confirmationPrompt" [style.top]="taskService.activeParentElement.offsetTop - 50 + 'px'" [style.left]="taskService.activeParentElement.offsetLeft + 75 + 'px'" *ngIf="taskService.deleteTaskPopup">
  This action cannot be undone! Are you sure you want to delete the task?
  <br>
  <button (click)="taskService.deleteTask(activeCategory, activeTask.id)" [disabled]="taskService.actionInProgress">
    Yes
    <i class="fa fa-spinner fa-spin" *ngIf="taskService.actionInProgress"></i>
  </button>
  <button (click)="taskService.deleteTaskPopup = undefined" [disabled]="taskService.actionInProgress">No</button>
</div>


<ng-template #showLogin>
  <!-- <app-404></app-404> -->
  You have to be logged in as an authorised user to view this page
</ng-template>